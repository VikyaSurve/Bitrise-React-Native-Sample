default_platform(:android)

platform :android do
  desc "Bump version code and version name"
  lane :bump_version do
    # Change to the correct directory for React Native
    Dir.chdir("android/app") do
      gradle_file = File.read("build.gradle")

      version_code = gradle_file.match(/versionCode\s+(\d+)/)[1].to_i
      version_name = gradle_file.match(/versionName\s+"([^\"]+)"/)[1]

      new_version_code = version_code + 1
      new_version_name = "#{version_name.split('.').first}.#{new_version_code}"

      new_gradle_file = gradle_file.gsub(/versionCode\s+\d+/, "versionCode #{new_version_code}")
      new_gradle_file = new_gradle_file.gsub(/versionName\s+"[^\"]+"/, "versionName \"#{new_version_name}\"")

      File.write("build.gradle", new_gradle_file)
    end

    git_commit(
      path: "android/app/build.gradle",
      message: "Version bump to #{new_version_name} (#{new_version_code})"
    )
  end
end
